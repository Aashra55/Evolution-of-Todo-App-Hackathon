# Real-time Sync Service: WebSocket Message Format

This document describes the expected message format for real-time synchronization between the Real-time Sync Service and connected clients via WebSocket. The service consumes events from internal Dapr Pub/Sub topics (`task-events`, `task-updates`) and translates them into client-understandable WebSocket messages.

## Message Structure

All messages sent over the WebSocket connection MUST adhere to a common JSON structure.

```json
{
  "type": "string",
  "payload": "object",
  "timestamp": "string"
}
```

-   `type` (String): Indicates the type of real-time update. Examples: `"TASK_CREATED"`, `"TASK_UPDATED"`, `"TASK_DELETED"`, `"BATCH_UPDATE"`.
-   `payload` (Object): Contains the actual data related to the update. The structure of `payload` varies based on the `type`.
-   `timestamp` (String, ISO 8601 format): The time when the update message was generated by the Real-time Sync Service.

## Message Types and Payloads

### 1. `TASK_CREATED`

Sent when a new task is created.

**Payload Structure**:
```json
{
  "task": {
    // Full Task object as defined in Chat API OpenAPI spec
    // Example:
    "id": "uuid",
    "title": "string",
    "status": "pending",
    "userId": "uuid",
    "createdAt": "datetime"
  }
}
```

### 2. `TASK_UPDATED`

Sent when an existing task is modified.

**Payload Structure**:
```json
{
  "taskId": "string", // ID of the updated task
  "changes": {
    // Object containing only the fields that were changed
    // Example:
    "status": "completed",
    "updatedAt": "datetime"
  },
  "fullTask": {
    // Optional: Full updated Task object for client convenience
  }
}
```

### 3. `TASK_DELETED`

Sent when a task is deleted.

**Payload Structure**:
```json
{
  "taskId": "string" // ID of the deleted task
}
```

### 4. `BATCH_UPDATE`

Sent when multiple task changes occur rapidly or for initial synchronization. Clients should handle this by re-rendering relevant parts of their UI or fetching a full state update.

**Payload Structure**:
```json
{
  "updates": [
    {
      "type": "TASK_CREATED",
      "payload": { /* ... */ }
    },
    {
      "type": "TASK_UPDATED",
      "payload": { /* ... */ }
    }
    // ... other update types
  ],
  "message": "Multiple updates detected, consider full sync if needed."
}
```

### 5. `ERROR`

Sent if an error occurs within the Real-time Sync Service that affects a client's connection or expected updates.

**Payload Structure**:
```json
{
  "code": "integer", // Error code
  "message": "string", // Human-readable error message
  "details": "object" // Optional: additional error details
}
```

## Connection & Protocol

-   Clients MUST establish a WebSocket connection to the Real-time Sync Service.
-   Messages MUST be sent and received as JSON strings over the WebSocket.
-   The service MAY implement a heartbeat/ping-pong mechanism to keep connections alive and detect stale clients.
-   Clients SHOULD be resilient to out-of-order messages for `TASK_UPDATED` by checking `timestamp` or by fetching full state on `BATCH_UPDATE`.
